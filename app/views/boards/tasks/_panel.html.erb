<%# Task edit slide-in panel for kanban board %>
<%
  status_labels = {
    "inbox" => "Inbox",
    "up_next" => "Up Next",
    "in_progress" => "In Progress",
    "in_review" => "In Review",
    "done" => "Done"
  }
  status_dot_colors = {
    "inbox" => "#666",
    "up_next" => "#60a5fa",
    "in_progress" => "#fbbf24",
    "in_review" => "#a78bfa",
    "done" => "#34d399"
  }
  priority_levels = [
    { id: "none", dots: 1, color: "#555" },
    { id: "low", dots: 2, color: "#60a5fa" },
    { id: "medium", dots: 3, color: "#fbbf24" },
    { id: "high", dots: 4, color: "#ef4444" },
  ]
  board_color_hex = board_hex_color(@board)
%>

<div data-controller="task-modal"
     data-task-modal-task-id-value="<%= task.id %>"
     data-task-modal-update-url-value="<%= board_task_path(@board, task) %>"
     data-task-modal-assign-url-value="<%= assign_board_task_path(@board, task) %>"
     data-task-modal-unassign-url-value="<%= unassign_board_task_path(@board, task) %>">
  <!-- Backdrop -->
  <div data-task-modal-target="backdrop"
       data-action="click->task-modal#close"
       style="position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:200"
       class="hidden opacity-0 transition-opacity duration-200 ease-out">
  </div>
  <!-- Slide-in Panel -->
  <div data-task-modal-target="modal"
       class="hidden translate-x-full transition-transform duration-200 ease-out"
       style="position:fixed;top:0;right:0;width:400px;height:100vh;background:#1a1a1e;border-left:1px solid rgba(255,255,255,0.06);display:flex;flex-direction:column;z-index:201;overflow:hidden">

    <!-- Header â€” status pill + close -->
    <div style="padding:16px 20px;border-bottom:1px solid rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:space-between">
      <div data-task-modal-target="statusPill" style="font-size:11px;font-weight:700;color:#ccc;background:rgba(255,255,255,0.06);padding:4px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.08)">
        <%= status_labels[task.status] %>
      </div>
      <button type="button"
              data-action="click->task-modal#close"
              style="background:none;border:none;cursor:pointer;color:#444;font-size:18px">âœ•</button>
    </div>

    <!-- Scrollable content -->
    <div style="flex:1;overflow-y:auto;padding:20px 20px 32px;display:flex;flex-direction:column;gap:24px">

      <%# === Auto-save form: title, notes, priority only === %>
      <%= form_with model: task, url: board_task_path(@board, task), method: :patch, style: "display:flex;flex-direction:column;gap:24px", data: { task_modal_target: "form" } do |form| %>
        <%= form.hidden_field :priority, value: task.priority, data: { task_modal_target: "priorityField" } %>

        <!-- Title -->
        <div>
          <%= form.text_field :name,
              placeholder: "Task title",
              style: "width:100%;font-size:20px;font-weight:800;color:#f0f0f0;letter-spacing:-0.02em;line-height:1.3;background:transparent;border:none;outline:none;padding:0;font-family:inherit",
              data: { task_modal_target: "nameField", action: "input->task-modal#scheduleAutoSave" } %>
        </div>

        <!-- Notes -->
        <div style="margin-top:20px">
          <%= form.text_area :description,
              placeholder: "Add notes...",
              style: "width:100%;min-height:120px;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.03);font-size:13px;color:#bbb;resize:vertical;outline:none;line-height:1.6;font-family:inherit",
              data: { task_modal_target: "descriptionField", action: "input->task-modal#scheduleAutoSave" } %>
        </div>

        <!-- Hidden submit button (triggered programmatically) -->
        <%= form.submit "Save", class: "hidden", data: { task_modal_target: "submitButton" } %>
      <% end %>

      <%# === Details section: status, priority, agent â€” outside form === %>
      <div>
        <div style="font-size:13px;font-weight:700;color:#e0e0e0;margin-bottom:14px">Details</div>

        <!-- Status row -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px" data-controller="dropdown">
          <span style="font-size:12px;font-weight:500;color:#888">Status</span>
          <div style="position:relative">
            <button type="button" data-action="click->dropdown#toggle" data-dropdown-target="button" aria-expanded="false"
                    style="display:flex;align-items:center;gap:7px;padding:5px 12px;border-radius:8px;cursor:pointer;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);transition:all 0.12s">
              <div data-task-modal-target="statusDot" style="width:6px;height:6px;border-radius:50%;background:<%= status_dot_colors[task.status] %>"></div>
              <span data-task-modal-target="statusLabel" style="font-size:12px;font-weight:600;color:#ccc"><%= status_labels[task.status] %></span>
              <svg width="10" height="10" viewBox="0 0 16 16" fill="none" style="opacity:0.3">
                <path d="M4 6L8 10L12 6" stroke="#888" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </button>
            <div data-dropdown-target="menu" class="hidden" style="position:absolute;top:calc(100% + 4px);right:0;width:180px;padding:4px;border-radius:10px;background:#222226;border:1px solid rgba(255,255,255,0.08);box-shadow:0 12px 40px rgba(0,0,0,0.5);z-index:10;animation:dropIn 0.12s ease both">
              <% status_labels.each do |status_key, status_label| %>
                <button type="button"
                        data-action="click->task-modal#changeStatus"
                        data-status="<%= status_key %>"
                        data-status-label="<%= status_label %>"
                        data-status-dot="<%= status_dot_colors[status_key] %>"
                        style="display:flex;align-items:center;gap:9px;width:100%;padding:8px 10px;border-radius:7px;background:<%= task.status == status_key ? 'rgba(255,255,255,0.06)' : 'transparent' %>;border:none;cursor:pointer;transition:background 0.1s;text-align:left"
                        onmouseenter="if(!this.dataset.active)this.style.background='rgba(255,255,255,0.04)'"
                        onmouseleave="if(!this.dataset.active)this.style.background='transparent'">
                  <div style="width:7px;height:7px;border-radius:50%;background:<%= status_dot_colors[status_key] %>"></div>
                  <span style="font-size:12px;font-weight:600;color:<%= task.status == status_key ? '#e0e0e0' : '#888' %>;flex:1"><%= status_label %></span>
                  <% if task.status == status_key %>
                    <svg width="12" height="12" viewBox="0 0 16 16" fill="none"><path d="M3 8.5L6.5 12L13 4" stroke="<%= status_dot_colors[status_key] %>" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  <% end %>
                </button>
              <% end %>
            </div>
          </div>
        </div>

        <!-- Priority row -->
        <%
          priority_cycle = %w[none low medium high]
          priority_config = {
            "none"   => { dots: 0, color: "#555",    bg: "rgba(255,255,255,0.03)",  border: "rgba(255,255,255,0.06)" },
            "low"    => { dots: 1, color: "#60a5fa",  bg: "rgba(96,165,250,0.10)",   border: "rgba(96,165,250,0.25)" },
            "medium" => { dots: 2, color: "#fbbf24",  bg: "rgba(251,191,36,0.10)",   border: "rgba(251,191,36,0.25)" },
            "high"   => { dots: 3, color: "#ef4444",  bg: "rgba(239,68,68,0.10)",    border: "rgba(239,68,68,0.25)" },
          }
          current_p = priority_config[task.priority] || priority_config["none"]
        %>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <span style="font-size:12px;font-weight:500;color:#888">Priority</span>
          <button type="button"
                  data-action="click->task-modal#cyclePriority"
                  data-task-modal-target="priorityButton"
                  data-priority-value="<%= task.priority %>"
                  style="width:100px;height:30px;border-radius:7px;cursor:pointer;background:<%= current_p[:bg] %>;border:1px solid <%= current_p[:border] %>;display:flex;align-items:center;justify-content:center;gap:2px;transition:all 0.12s">
            <% if current_p[:dots] == 0 %>
              <div style="width:5px;height:5px;border-radius:50%;background:#555;opacity:0.3"></div>
            <% else %>
              <% current_p[:dots].times do %>
                <div style="width:5px;height:5px;border-radius:50%;background:<%= current_p[:color] %>"></div>
              <% end %>
            <% end %>
          </button>
        </div>

        <!-- Agent row -->
        <div style="display:flex;align-items:center;justify-content:space-between">
          <span style="font-size:12px;font-weight:500;color:#888">Agent</span>
          <% if task.assigned_to_agent? %>
            <button type="button"
                    data-action="click->task-modal#toggleAgent"
                    style="width:100px;height:30px;display:flex;align-items:center;justify-content:center;gap:5px;border-radius:7px;cursor:pointer;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.2);transition:all 0.12s">
              <span style="font-size:11px">ðŸ¤–</span>
              <span style="font-size:11px;font-weight:600;color:#fbbf24">Assigned</span>
            </button>
          <% else %>
            <% agent_connected = current_user.agent_last_active_at.present? %>
            <% if agent_connected %>
              <button type="button"
                      data-action="click->task-modal#toggleAgent"
                      style="width:100px;height:30px;display:flex;align-items:center;justify-content:center;gap:5px;border-radius:7px;cursor:pointer;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);transition:all 0.12s">
                <span style="font-size:11px">ðŸ¤–</span>
                <span style="font-size:11px;font-weight:600;color:#555">Assign</span>
              </button>
            <% else %>
              <span style="width:100px;height:30px;display:flex;align-items:center;justify-content:center;gap:5px;border-radius:7px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);cursor:not-allowed">
                <span style="font-size:11px">ðŸ¤–</span>
                <span style="font-size:11px;font-weight:600;color:#555">Assign</span>
              </span>
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- Agent Status Banner -->
      <% if task.assigned_to_agent? && task.agent_claimed_at.present? %>
        <% agent_done = task.status == "done" || task.status == "in_review" %>
        <div style="padding:12px 14px;border-radius:10px;background:<%= agent_done ? 'rgba(52,211,153,0.05)' : 'rgba(251,191,36,0.05)' %>;border:1px solid <%= agent_done ? 'rgba(52,211,153,0.10)' : 'rgba(251,191,36,0.10)' %>;display:flex;align-items:center;gap:9px">
          <span style="font-size:16px">ðŸ¤–</span>
          <div>
            <div style="font-size:12px;font-weight:600;color:<%= agent_done ? '#34d399' : '#fbbf24' %>">
              <%= agent_done ? 'Agent finished â€” needs review' : 'Agent is working on this' %>
            </div>
            <div style="font-size:11px;font-weight:500;color:#444;margin-top:2px">
              <%= agent_done ? 'Review changes before moving to Done' : 'Check back soon for updates' %>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Subtasks -->
      <% subtasks = task.subtasks %>
      <% if subtasks.any? %>
        <% done_count = subtasks.count(&:done?) %>
        <% total_count = subtasks.size %>
        <% progress = total_count > 0 ? (done_count.to_f / total_count * 100).round : 0 %>
        <div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <div style="font-size:10px;font-weight:700;color:#444;text-transform:uppercase;letter-spacing:0.06em">Subtasks</div>
            <span style="font-size:10px;font-weight:600;color:#444"><%= done_count %>/<%= total_count %></span>
          </div>
          <div style="height:3px;border-radius:2px;background:rgba(255,255,255,0.05);margin-bottom:10px;overflow:hidden">
            <div style="height:100%;border-radius:2px;background:<%= board_color_hex %>;width:<%= progress %>%;opacity:0.8"></div>
          </div>
          <div id="task_<%= task.id %>_subtasks" style="display:flex;flex-direction:column;gap:3px">
            <% subtasks.each do |subtask| %>
              <%= button_to board_task_subtask_path(@board, task, subtask),
                  method: :patch,
                  params: { subtask: { done: !subtask.done? } },
                  style: "display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);cursor:pointer" do %>
                <% if subtask.done? %>
                  <div style="width:16px;height:16px;border-radius:4px;background:<%= board_color_hex %>;display:flex;align-items:center;justify-content:center;flex-shrink:0">
                    <svg width="9" height="9" viewBox="0 0 16 16" fill="none"><path d="M3 8.5L6.5 12L13 4" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  </div>
                <% else %>
                  <div style="width:16px;height:16px;border-radius:4px;border:1.5px solid rgba(255,255,255,0.15);background:transparent;flex-shrink:0"></div>
                <% end %>
                <span style="font-size:12.5px;font-weight:500;color:<%= subtask.done? ? '#444' : '#bbb' %>;<%= 'text-decoration:line-through' if subtask.done? %>"><%= subtask.title %></span>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Agent Suggestion Hint -->
      <% if task.agent_hint.present? %>
        <div style="padding:12px 14px;border-radius:10px;background:rgba(251,191,36,0.04);border:1px solid rgba(251,191,36,0.08);display:flex;align-items:flex-start;gap:9px">
          <span style="font-size:14px;margin-top:1px">ðŸ’¡</span>
          <div>
            <div style="font-size:12px;font-weight:600;color:#fbbf24;margin-bottom:2px">Suggestion</div>
            <div style="font-size:12px;font-weight:500;color:#888;line-height:1.4"><%= task.agent_hint %></div>
          </div>
        </div>
      <% end %>

      <!-- Activity Feed -->
      <div>
        <div style="font-size:13px;font-weight:700;color:#e0e0e0;margin-bottom:14px">Activity</div>
        <%= render "shared/task_activities", task: task %>
      </div>
    </div>
  </div>
</div>
