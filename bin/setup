#!/usr/bin/env ruby
require "fileutils"
require "rbconfig"
require "rubygems"

APP_ROOT = File.expand_path("..", __dir__)

def system!(*args)
  system(*args, exception: true)
end

def bundled_with_version(lockfile_path)
  lockfile = File.read(lockfile_path)
  match = lockfile.match(/^BUNDLED WITH\n\s+([0-9.]+)\s*$/m)
  match&.captures&.first
end

def required_ruby_version(version_file_path)
  File.read(version_file_path).strip.sub(/\Aruby-/, "")
end

def ensure_supported_ruby!(required_version)
  current_version = Gem::Version.new(RUBY_VERSION)
  requirement = Gem::Requirement.new("~> #{required_version}")

  return if requirement.satisfied_by?(current_version)

  abort <<~MSG
    Ruby #{required_version} (3.3.x) is required for this app.
    Current Ruby: #{RUBY_VERSION} (#{RbConfig.ruby})

    Install a modern Ruby and try again:
      homebrew: brew install ruby@3.3 && export PATH="/opt/homebrew/opt/ruby@3.3/bin:$PATH"
      mise:  brew install mise && mise install ruby@#{required_version}
      rbenv: brew install rbenv ruby-build && rbenv install #{required_version}
  MSG
end

def ensure_bundler!(bundler_version)
  return if Gem::Specification.find_all_by_name("bundler", bundler_version).any?

  puts "Bundler #{bundler_version} not found. Installing..."
  system!("gem", "install", "bundler", "-v", bundler_version)
end

FileUtils.chdir APP_ROOT do
  required_ruby = required_ruby_version(".ruby-version")
  bundled_with = bundled_with_version("Gemfile.lock")

  abort "Could not read Bundler version from Gemfile.lock" unless bundled_with

  ensure_supported_ruby!(required_ruby)
  ensure_bundler!(bundled_with)

  bundle_cmd = [ "bundle", "_#{bundled_with}_" ]

  # This script is a way to set up or update your development environment automatically.
  # This script is idempotent, so that you can run it at any time and get an expectable outcome.
  # Add necessary setup steps to this file.

  puts "== Installing dependencies =="
  system(*bundle_cmd, "check") || system!(*bundle_cmd, "install")

  # puts "\n== Copying sample files =="
  # unless File.exist?("config/database.yml")
  #   FileUtils.cp "config/database.yml.sample", "config/database.yml"
  # end

  puts "\n== Preparing database =="
  system!(*bundle_cmd, "exec", "bin/rails", "db:prepare")
  system!(*bundle_cmd, "exec", "bin/rails", "db:reset") if ARGV.include?("--reset")

  puts "\n== Removing old logs and tempfiles =="
  system!(*bundle_cmd, "exec", "bin/rails", "log:clear", "tmp:clear")

  if ARGV.include?("--skip-server")
    puts "\n== Setup complete =="
    puts "Run these commands next:"
    puts "  #{bundle_cmd.join(" ")} exec bin/rails db:migrate"
    puts "  #{bundle_cmd.join(" ")} exec bin/rails test"
  else
    puts "\n== Starting development server =="
    STDOUT.flush # flush the output before exec(2) so that it displays
    exec(*bundle_cmd, "exec", "bin/dev")
  end
end
